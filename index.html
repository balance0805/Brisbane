<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¾³æ´²è¨˜å¸³åˆ†éŒ¢å°å¹«æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style> body { -webkit-tap-highlight-color: transparent; } </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        // --- åœ–ç¤ºçµ„ä»¶ ---
        const Icon = ({ path, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );
        const Plus = (props) => <Icon {...props} path={<><path d="M5 12h14"/><path d="M12 5v14"/></>} />;
        const Trash2 = (props) => <Icon {...props} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-1 1-1h6c0 0 1 0 1 1v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />;
        const DollarSign = (props) => <Icon {...props} path={<><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></>} />;
        const Users = (props) => <Icon {...props} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />;
        const RefreshCw = (props) => <Icon {...props} path={<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></>} />;
        const Save = (props) => <Icon {...props} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />;
        const Calculator = (props) => <Icon {...props} path={<><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></>} />;
        const RotateCcw = (props) => <Icon {...props} path={<><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></>} />;

        const { useState, useEffect, useMemo } = React;

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-lg p-6 ${className}`}>
                {children}
            </div>
        );

        const Button = ({ onClick, children, variant = "primary", className = "", disabled = false }) => {
            const baseStyle = "px-4 py-2 rounded-lg font-medium transition-colors flex items-center justify-center gap-2";
            const variants = {
                primary: "bg-emerald-600 text-white hover:bg-emerald-700 active:bg-emerald-800",
                secondary: "bg-gray-100 text-gray-700 hover:bg-gray-200",
                danger: "bg-red-50 text-red-600 hover:bg-red-100",
                outline: "border-2 border-emerald-600 text-emerald-600 hover:bg-emerald-50"
            };
            return (
                <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${className}`}>{children}</button>
            );
        };

        const App = () => {
            // --- State with LocalStorage Initialization ---
            const [activeTab, setActiveTab] = useState('expenses'); 
            const [rate, setRate] = useState(() => parseFloat(localStorage.getItem('aus_rate')) || 21.5); 
            const [rateLoading, setRateLoading] = useState(false);
            
            const [users, setUsers] = useState(() => {
                const saved = localStorage.getItem('aus_users');
                return saved ? JSON.parse(saved) : ['æˆ‘', 'æ—…ä¼´A'];
            });
            
            const [expenses, setExpenses] = useState(() => {
                const saved = localStorage.getItem('aus_expenses');
                return saved ? JSON.parse(saved) : [];
            });

            // Input states
            const [newUser, setNewUser] = useState('');
            const [description, setDescription] = useState('');
            const [amount, setAmount] = useState('');
            const [currency, setCurrency] = useState('AUD');
            const [payer, setPayer] = useState(users[0] || 'æˆ‘');

            // --- Persistence Effects ---
            useEffect(() => { localStorage.setItem('aus_users', JSON.stringify(users)); }, [users]);
            useEffect(() => { localStorage.setItem('aus_expenses', JSON.stringify(expenses)); }, [expenses]);
            useEffect(() => { localStorage.setItem('aus_rate', rate); }, [rate]);

            // --- Initialize Rate ---
            useEffect(() => {
                if (!localStorage.getItem('aus_rate')) {
                    fetchRate();
                }
            }, []);

            const fetchRate = async () => {
                setRateLoading(true);
                try {
                    const response = await fetch('https://api.exchangerate-api.com/v4/latest/AUD');
                    const data = await response.json();
                    if (data && data.rates && data.rates.TWD) {
                        setRate(data.rates.TWD);
                    }
                } catch (error) {
                    console.error("Failed to fetch rate", error);
                } finally {
                    setRateLoading(false);
                }
            };

            const resetAllData = () => {
                if(confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ç´€éŒ„å—ï¼Ÿé€™å°‡ç„¡æ³•å¾©åŸã€‚")) {
                    localStorage.removeItem('aus_expenses');
                    localStorage.removeItem('aus_users');
                    setExpenses([]);
                    setUsers(['æˆ‘', 'æ—…ä¼´A']);
                    alert("å·²é‡ç½®æ‰€æœ‰è³‡æ–™ï¼");
                }
            }

            // --- Handlers ---
            const addUser = () => {
                if (newUser.trim() && !users.includes(newUser.trim())) {
                    setUsers([...users, newUser.trim()]);
                    setNewUser('');
                }
            };

            const removeUser = (userToRemove) => {
                const isInvolved = expenses.some(e => e.payer === userToRemove);
                if (isInvolved) {
                    alert("ç„¡æ³•åˆªé™¤ï¼šæ­¤äººå·²æœ‰ä»˜æ¬¾ç´€éŒ„ï¼Œè«‹å…ˆåˆªé™¤ç›¸é—œå¸³ç›®ã€‚");
                    return;
                }
                setUsers(users.filter(u => u !== userToRemove));
                if (payer === userToRemove) setPayer(users[0] || '');
            };

            const addExpense = () => {
                if (!description || !amount || !payer) return;
                const numAmount = parseFloat(amount);
                if (isNaN(numAmount) || numAmount <= 0) return;

                const newExpense = {
                    id: Date.now(),
                    description,
                    amount: numAmount,
                    currency,
                    payer,
                    date: new Date().toLocaleDateString()
                };

                setExpenses([newExpense, ...expenses]); 
                setDescription('');
                setAmount('');
            };

            const deleteExpense = (id) => {
                setExpenses(expenses.filter(e => e.id !== id));
            };

            // --- Calculation Logic ---
            const settlement = useMemo(() => {
                if (users.length === 0) return { totalSpentAUD: 0, transactions: [], balances: {} };

                let balances = {}; 
                users.forEach(u => balances[u] = 0);
                let totalSpentAUD = 0;
                
                expenses.forEach(e => {
                    const amountInAUD = e.currency === 'TWD' ? (e.amount / (rate || 1)) : e.amount;
                    totalSpentAUD += amountInAUD;
                    const splitAmount = amountInAUD / users.length;
                    balances[e.payer] += amountInAUD;
                    users.forEach(u => { balances[u] -= splitAmount; });
                });

                let debtors = [];
                let creditors = [];

                Object.entries(balances).forEach(([name, amount]) => {
                    if (amount < -0.01) debtors.push({ name, amount });
                    if (amount > 0.01) creditors.push({ name, amount });
                });

                debtors.sort((a, b) => a.amount - b.amount); 
                creditors.sort((a, b) => b.amount - a.amount); 

                const transactions = [];
                let i = 0; let j = 0; 
                while (i < debtors.length && j < creditors.length) {
                    let debtor = debtors[i];
                    let creditor = creditors[j];
                    let amount = Math.min(Math.abs(debtor.amount), creditor.amount);
                    transactions.push({ from: debtor.name, to: creditor.name, amount: amount });
                    debtor.amount += amount;
                    creditor.amount -= amount;
                    if (Math.abs(debtor.amount) < 0.01) i++;
                    if (creditor.amount < 0.01) j++;
                }
                return { totalSpentAUD, transactions, balances };
            }, [users, expenses, rate]);

            // --- Formatters ---
            const formatMoney = (val, cur) => {
                if (cur === 'AUD') return new Intl.NumberFormat('en-AU', { style: 'currency', currency: 'AUD' }).format(val);
                if (cur === 'TWD') return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(val);
                return val;
            };
            const toTWD = (audVal) => audVal * rate;

            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 font-sans pb-24 md:pb-10">
                    {/* Header */}
                    <header className="bg-emerald-600 text-white p-6 shadow-md">
                        <div className="max-w-md mx-auto">
                            <h1 className="text-2xl font-bold flex items-center gap-2">
                                <span className="text-3xl">ğŸ¦˜</span> æ¾³æ´²è¨˜å¸³åˆ†éŒ¢
                            </h1>
                            <div className="mt-4 flex items-center gap-2 bg-emerald-700/50 p-3 rounded-lg backdrop-blur-sm">
                                <span className="text-sm font-medium opacity-90">åŒ¯ç‡ (AUD to TWD):</span>
                                <input type="number" value={rate} onChange={(e) => setRate(e.target.value)} className="w-20 px-2 py-1 rounded text-slate-800 font-bold text-center focus:outline-none"/>
                                <button onClick={fetchRate} className={`p-1.5 rounded-full hover:bg-emerald-600 transition-all ${rateLoading ? 'animate-spin' : ''}`} title="æ›´æ–°åŒ¯ç‡"><RefreshCw size={16} /></button>
                            </div>
                        </div>
                    </header>

                    {/* Main Content Area */}
                    <main className="max-w-md mx-auto p-4 space-y-6">
                        {/* Tab Navigation */}
                        <div className="flex p-1 bg-white rounded-xl shadow-sm border border-slate-200 sticky top-4 z-10">
                            {[{ id: 'expenses', label: 'è¨˜å¸³', icon: DollarSign }, { id: 'people', label: 'æˆå“¡', icon: Users }, { id: 'settle', label: 'çµç®—', icon: Calculator }].map(tab => (
                                <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-1 flex items-center justify-center gap-2 py-2.5 text-sm font-bold rounded-lg transition-all ${activeTab === tab.id ? 'bg-emerald-100 text-emerald-700' : 'text-slate-500 hover:bg-slate-50'}`}>
                                    <tab.icon size={18} /> {tab.label}
                                </button>
                            ))}
                        </div>

                        {/* --- EXPENSES TAB --- */}
                        {activeTab === 'expenses' && (
                            <div className="space-y-6">
                                <Card className="border-t-4 border-emerald-500">
                                    <h2 className="text-lg font-bold mb-4 flex items-center gap-2"><Plus className="text-emerald-600" /> æ–°å¢æ¬¾é …</h2>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">é …ç›®åç¨±</label>
                                            <input type="text" value={description} onChange={(e) => setDescription(e.target.value)} placeholder="ä¾‹å¦‚ï¼šColes æ¡è³¼, æˆ¿ç§Ÿ..." className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none"/>
                                        </div>
                                        <div className="flex gap-3">
                                            <div className="flex-[2]">
                                                <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">é‡‘é¡</label>
                                                <div className="flex">
                                                    <select value={currency} onChange={(e) => setCurrency(e.target.value)} className="bg-slate-100 border border-r-0 border-slate-200 rounded-l-lg px-2 font-bold text-slate-600 focus:outline-none">
                                                        <option value="AUD">AUD</option><option value="TWD">TWD</option>
                                                    </select>
                                                    <input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} placeholder="0.00" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-r-lg focus:ring-2 focus:ring-emerald-500 outline-none font-mono text-lg"/>
                                                </div>
                                            </div>
                                            <div className="flex-1">
                                                <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">ä»˜æ¬¾äºº</label>
                                                <select value={payer} onChange={(e) => setPayer(e.target.value)} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none h-[52px]">
                                                    {users.map(u => <option key={u} value={u}>{u}</option>)}
                                                </select>
                                            </div>
                                        </div>
                                        <div className="pt-2"><Button onClick={addExpense} className="w-full py-3 text-lg">æ–°å¢ç´€éŒ„</Button></div>
                                    </div>
                                </Card>
                                <div className="space-y-3">
                                    <div className="flex justify-between items-end px-2"><h3 className="font-bold text-slate-700">æœ€è¿‘ç´€éŒ„</h3><span className="text-xs text-slate-500">å…± {expenses.length} ç­†</span></div>
                                    {expenses.length === 0 ? (
                                        <div className="text-center py-10 text-slate-400 bg-slate-50 rounded-xl border border-dashed border-slate-300"><p>é‚„æ²’æœ‰è¨˜å¸³ç´€éŒ„å–”</p></div>
                                    ) : (
                                        expenses.map((expense) => (
                                            <div key={expense.id} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center group">
                                                <div>
                                                    <h4 className="font-bold text-slate-800">{expense.description}</h4>
                                                    <p className="text-sm text-slate-500"><span className="font-medium text-emerald-600">{expense.payer}</span> å…ˆä»˜ â€¢ {expense.date}</p>
                                                </div>
                                                <div className="flex items-center gap-4">
                                                    <div className="text-right">
                                                        <div className="font-bold text-slate-800">{formatMoney(expense.amount, expense.currency)}</div>
                                                        <div className="text-xs text-slate-400">{expense.currency === 'AUD' ? `â‰ˆ ${formatMoney(toTWD(expense.amount), 'TWD')}` : `â‰ˆ ${formatMoney(expense.amount / rate, 'AUD')}`}</div>
                                                    </div>
                                                    <button onClick={() => deleteExpense(expense.id)} className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors"><Trash2 size={18} /></button>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        )}

                        {/* --- PEOPLE TAB --- */}
                        {activeTab === 'people' && (
                            <div className="space-y-6">
                                <Card>
                                    <h2 className="text-lg font-bold mb-4">ç®¡ç†æˆå“¡</h2>
                                    <div className="flex gap-2 mb-6">
                                        <input type="text" value={newUser} onChange={(e) => setNewUser(e.target.value)} placeholder="è¼¸å…¥åå­—..." className="flex-1 p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" onKeyDown={(e) => e.key === 'Enter' && addUser()}/>
                                        <Button onClick={addUser} variant="secondary"><Plus size={20} /></Button>
                                    </div>
                                    <div className="grid gap-3">
                                        {users.map((user) => (
                                            <div key={user} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-100">
                                                <div className="flex items-center gap-3"><div className="w-8 h-8 rounded-full bg-emerald-100 text-emerald-700 flex items-center justify-center font-bold text-sm">{user.charAt(0)}</div><span className="font-medium">{user}</span></div>
                                                {users.length > 1 && (<button onClick={() => removeUser(user)} className="text-slate-400 hover:text-red-500 transition-colors p-2"><Trash2 size={16} /></button>)}
                                            </div>
                                        ))}
                                    </div>
                                </Card>
                                <div className="text-center pt-8">
                                    <button onClick={resetAllData} className="text-red-400 text-sm flex items-center justify-center gap-2 mx-auto hover:text-red-600 transition-colors"><RotateCcw size={14}/> åˆªé™¤æ‰€æœ‰è³‡æ–™ä¸¦é‡ç½®</button>
                                </div>
                            </div>
                        )}

                        {/* --- SETTLE TAB --- */}
                        {activeTab === 'settle' && (
                            <div className="space-y-6">
                                <div className="bg-gradient-to-r from-emerald-600 to-teal-600 rounded-xl p-6 text-white shadow-lg">
                                    <p className="text-emerald-100 text-sm font-medium mb-1">ç¸½æ”¯å‡º (æŠ˜åˆæ¾³å¹£)</p>
                                    <div className="text-4xl font-bold mb-2">{formatMoney(settlement.totalSpentAUD, 'AUD')}</div>
                                    <div className="text-emerald-100 opacity-90">â‰ˆ {formatMoney(toTWD(settlement.totalSpentAUD), 'TWD')}</div>
                                    <div className="mt-4 pt-4 border-t border-white/20 text-sm">æ¯äººæ‡‰ä»˜ï¼š<span className="font-bold">{formatMoney(settlement.totalSpentAUD / (users.length || 1), 'AUD')}</span></div>
                                </div>
                                <Card>
                                    <h2 className="text-lg font-bold mb-4 flex items-center gap-2"><Save className="text-emerald-600" size={20} /> æœ€ä½³çµç®—æ–¹æ¡ˆ</h2>
                                    {settlement.transactions.length === 0 ? (
                                        <div className="text-center py-8 text-slate-400"><p>ç›®å‰æ²’æœ‰éœ€è¦çµç®—çš„æ¬¾é … ğŸ‰</p></div>
                                    ) : (
                                        <div className="space-y-4">
                                            {settlement.transactions.map((t, idx) => (
                                                <div key={idx} className="bg-slate-50 p-4 rounded-xl border border-slate-200 flex flex-col gap-2">
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex items-center gap-2 font-bold text-slate-700"><span className="bg-white px-2 py-1 rounded shadow-sm border">{t.from}</span><span className="text-slate-400 text-xs">çµ¦</span><span className="bg-white px-2 py-1 rounded shadow-sm border">{t.to}</span></div>
                                                        <div className="text-right"><div className="font-bold text-lg text-emerald-700">{formatMoney(t.amount, 'AUD')}</div></div>
                                                    </div>
                                                    <div className="text-right text-xs text-slate-500 font-medium border-t border-slate-200 pt-2 mt-1">æˆ–æ˜¯å°å¹£ <span className="text-emerald-600">{formatMoney(toTWD(t.amount), 'TWD')}</span></div>
                                                </div>
                                            ))}
                                            <div className="bg-yellow-50 text-yellow-800 text-xs p-3 rounded-lg mt-4">ğŸ’¡ ç³»çµ±å°‡æ‰€æœ‰å°å¹£æ”¯å‡ºä¾åŒ¯ç‡è‡ªå‹•è½‰ç‚ºæ¾³å¹£é€²è¡Œé‹ç®—ã€‚</div>
                                        </div>
                                    )}
                                </Card>
                                <div className="px-2">
                                    <h3 className="text-sm font-bold text-slate-500 uppercase mb-3">è©³ç´°é¤˜é¡ç‹€æ…‹ (ä»¥æ¾³å¹£è¨ˆ)</h3>
                                    <div className="space-y-2">
                                        {Object.entries(settlement.balances).map(([name, amount]) => (
                                            <div key={name} className="flex justify-between items-center text-sm"><span>{name}</span><span className={amount > 0 ? "text-emerald-600 font-bold" : amount < 0 ? "text-red-500 font-bold" : "text-slate-400"}>{amount > 0 ? `å¤šä»˜äº† ${formatMoney(amount, 'AUD')}` : amount < 0 ? `å°‘ä»˜äº† ${formatMoney(Math.abs(amount), 'AUD')}` : "çµæ¸…"}</span></div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

